name: CI
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize]
  workflow_call:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run unit tests
        run: yarn test

  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - name: Setup
  #       uses: ./.github/actions/setup

  #     - name: Build package
  #       run: yarn prepack

  sonar-scan:
    runs-on: ubuntu-latest
    name: Sonar scan

    needs: [test]

    steps:
      - name: checkout repository
        uses: actions/cache@v3
        id: repo
        with:
          path: ./*
          key: ${{ github.sha }}

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: test-report
          path: coverage

      - name: List artifacts
        run: ls -laR coverage

      - name: Sonar scan
        uses: ./.github/actions/sonar-scan
        with:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
